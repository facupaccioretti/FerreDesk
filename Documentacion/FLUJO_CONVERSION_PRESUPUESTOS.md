# Flujo de Conversiรณn de Presupuestos y Cotizaciones

## Resumen

Este documento explica el flujo completo de conversiรณn de presupuestos y cotizaciones (facturas internas) a facturas fiscales, incluyendo el manejo de recibos de excedente y auto-imputaciones.

---

## ๐ Diagrama de Flujo General

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     INICIO: Usuario en Lista                     โ
โ                                                                   โ
โ  PresupuestosManager.js / ComprobantesList.js                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
                  [Click "Convertir"]
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  useComprobantesCRUD.handleConvertir            โ
โ                                                                   โ
โ  1. Fetch cabecera: /api/venta-calculada/{id}/                  โ
โ  2. Fetch items: /api/venta-detalle-item-calculado/?vdi_idve={id}โ
โ  3. Agregar IDs a items                                          โ
โ  4. Abrir ConversionModal                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      ConversionModal.js                          โ
โ                                                                   โ
โ  - Muestra lista de items del presupuesto/cotizaciรณn            โ
โ  - Usuario selecciona items (checkboxes)                        โ
โ  - Estado local: selectedItems = [id1, id2, ...]                โ
โ  - Click "Convertir"                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
          useComprobantesCRUD.handleConversionConfirm
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          Preparar datos para ConVentaForm                        โ
โ                                                                   โ
โ  tabData = {                                                     โ
โ    presupuestoOrigen: datos,           // Para presupuestos     โ
โ    facturaInternaOrigen: datos,        // Para cotizaciones     โ
โ    itemsSeleccionados: [...],          // Items completos       โ
โ    itemsSeleccionadosIds: selectedItems, // Solo IDs [1,2,3]    โ
โ    tipoConversion: 'presupuesto_venta' | 'factura_i_factura'    โ
โ  }                                                               โ
โ                                                                   โ
โ  - Crear tab con updateTabData(tabKey, label, tabData, tipoTab) โ
โ  - Cerrar modal                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       ConVentaForm.js                            โ
โ                                                                   โ
โ  Props recibidos:                                                โ
โ  - presupuestoOrigen (si es presupuesto)                        โ
โ  - facturaInternaOrigen (si es cotizaciรณn)                      โ
โ  - itemsSeleccionados (items completos)                         โ
โ  - itemsSeleccionadosIds ([1,2,3])  โ PROP                      โ
โ  - tipoConversion                                                โ
โ  - onSave                                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          ConVentaForm: Inicializaciรณn de Estado                  โ
โ                                                                   โ
โ  const [idsSeleccionados, setIdsSeleccionados] = useState(      โ
โ    itemsSeleccionadosIds || itemsSeleccionados.map(i => i.id)   โ
โ  );                                                              โ
โ                                                                   โ
โ  useEffect(() => {                                               โ
โ    // Sincronizar estado con props                              โ
โ    if (itemsSeleccionadosIds) {                                  โ
โ      setIdsSeleccionados(itemsSeleccionadosIds);                โ
โ    }                                                             โ
โ  }, [itemsSeleccionadosIds]);                                    โ
โ                                                                   โ
โ  idsSeleccionados โ ESTADO LOCAL (sincronizado)                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
                  [Usuario completa formulario]
                            โ
                            โผ
                  [Click "Guardar/Emitir"]
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 ConVentaForm.handleSubmit()                      โ
โ                                                                   โ
โ  1. Validar campos                                               โ
โ  2. Construir payload base                                       โ
โ  3. Agregar campos de conversiรณn:                                โ
โ     - presupuesto_origen: id                                     โ
โ     - items_seleccionados: idsSeleccionados  โ USA ESTADO       โ
โ  4. Verificar si montoPago > total                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                โโโโโโโโโโโโโดโโโโโโโโโโโโโ
                โ                        โ
                โผ                        โผ
        montoPago <= total      montoPago > total + 0.99
                โ                        โ
                โ                        โผ
                โ          โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ          โ  Detectar EXCEDENTE      โ
                โ          โ  excedente = monto - totalโ
                โ          โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                โ                     โ
                โ                     โผ
                โ          โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ          โ  Confirmar con usuario    โ
                โ          โ  ยฟCrear recibo excedente? โ
                โ          โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                โ                     โ
                โ          โโโโโโโโโโโโดโโโโโโโโโโโโโโ
                โ          โ                        โ
                โ          โผ                        โผ
                โ      Usuario                 Usuario
                โ      Cancela                 Acepta
                โ          โ                        โ
                โ          โผ                        โผ
                โ      [Abort]        โโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ                     โ  Abrir NuevoReciboModal  โ
                โ                     โ  con datos precargados   โ
                โ                     โ  - monto: excedente      โ
                โ                     โ  - cliente: mismo        โ
                โ                     โ  - fecha: hoy            โ
                โ                     โโโโโโโโโโโโฌโโโโโโโโโโโโโโโ
                โ                                โ
                โ                                โผ
                โ                     [Usuario completa recibo]
                โ                                โ
                โ                                โผ
                โ              handleReciboExcedenteGuardado(reciboData)
                โ                                โ
                โ                                โผ
                โ                     setReciboExcedente(reciboData)
                โ                                โ
                โ                                โผ
                โ                     setTimeout(() => {
                โ                       realizarSubmitVenta(reciboData)
                โ                     }, 100)
                โ                                โ
                โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                                 โ
                                                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              ConVentaForm.realizarSubmitVenta()                  โ
โ                                                                   โ
โ  1. Construir payload (IGUAL que handleSubmit)                   โ
โ  2. DIFERENCIA CLAVE: Agregar campos segรบn tipo conversiรณn       โ
โ                                                                   โ
โ     if (esConversionFacturaI) {                                  โ
โ       payload.items = items.map(...)                             โ
โ       payload.factura_interna_origen = id                        โ
โ       payload.tipo_conversion = 'factura_i_factura'              โ
โ     } else {                                                     โ
โ       payload.items_seleccionados = idsSeleccionados โ ESTADO   โ
โ       payload.presupuesto_origen = id                            โ
โ       payload.tipo_conversion = 'presupuesto_factura'            โ
โ     }                                                            โ
โ                                                                   โ
โ  3. Si hay reciboData, agregar:                                  โ
โ     payload.recibo_excedente = reciboData                        โ
โ                                                                   โ
โ  4. Determinar endpoint correcto:                                โ
โ     - Factura interna: /api/convertir-factura-interna/          โ
โ     - Presupuesto: /api/convertir-presupuesto/                  โ
โ                                                                   โ
โ  5. Llamar: onSave(payload, tabKey, endpoint)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          useComprobantesCRUD.handleConVentaFormSave             โ
โ                                                                   โ
โ  1. Detectar endpoint del parรกmetro (3er argumento)             โ
โ  2. POST al endpoint correspondiente con payload                 โ
โ  3. Retornar respuesta                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              BACKEND: convertir_presupuesto_a_venta             โ
โ              (ferredesk_v0/backend/ferreapps/ventas/views.py)   โ
โ                                                                   โ
โ  1. Validar datos recibidos:                                     โ
โ     - presupuesto_origen (ID)                                    โ
โ     - items_seleccionados ([1, 2, 3])  โ CRรTICO                โ
โ                                                                   โ
โ  2. Obtener presupuesto original con select_for_update()         โ
โ                                                                   โ
โ  3. Copiar items seleccionados del presupuesto:                  โ
โ     for item_id in items_seleccionados:                          โ
โ       item_original = VentaDetalleItem.get(id=item_id)           โ
โ       crear nuevo item en venta                                  โ
โ                                                                   โ
โ  4. Crear venta nueva usando VentaSerializer                     โ
โ                                                                   โ
โ  5. Obtener venta reciรฉn creada: Venta.objects.get(ven_id=...)  โ
โ                                                                   โ
โ  6. SI comprobante_pagado y monto_pago > 0:                      โ
โ     - Obtener total desde VentaCalculada โ IMPORTANTE           โ
โ       venta_calc = VentaCalculada.objects.filter(               โ
โ         ven_id=venta_creada.ven_id                               โ
โ       ).first()                                                  โ
โ       total = venta_calc.ven_total                               โ
โ                                                                   โ
โ     - Crear auto-imputaciรณn:                                     โ
โ       monto_auto = min(monto_pago, total)                        โ
โ       ImputacionVenta.objects.create(                            โ
โ         imp_id_venta=venta_creada,                               โ
โ         imp_id_recibo=venta_creada,  โ Misma venta              โ
โ         imp_monto=monto_auto,                                    โ
โ         imp_observacion='Factura Recibo - Auto-imputaciรณn'      โ
โ       )                                                          โ
โ                                                                   โ
โ  7. SI existe recibo_excedente en payload:                       โ
โ     - Validar monto del recibo vs excedente calculado            โ
โ       excedente = monto_pago - total                             โ
โ       validar abs(monto_recibo - excedente) < 0.01               โ
โ                                                                   โ
โ     - Obtener comprobante de recibo (letra X)                    โ
โ                                                                   โ
โ     - Crear recibo:                                              โ
โ       recibo = Venta.objects.create(                             โ
โ         comprobante=comprobante_recibo,                          โ
โ         ven_punto=rec_pv,                                        โ
โ         ven_numero=rec_num,                                      โ
โ         ven_idcli=venta_creada.ven_idcli,                        โ
โ         ...                                                      โ
โ       )                                                          โ
โ                                                                   โ
โ     - Crear item genรฉrico para el recibo:                        โ
โ       VentaDetalleItem.objects.create(                           โ
โ         vdi_idve=recibo,                                         โ
โ         vdi_cantidad=1,                                          โ
โ         vdi_precio_unitario_final=monto_recibo,                  โ
โ         vdi_detalle1=f'Recibo X {rec_pv}-{rec_num}',            โ
โ         ...                                                      โ
โ       )                                                          โ
โ                                                                   โ
โ  8. Retornar respuesta con datos de venta creada                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     Resultado Final                              โ
โ                                                                   โ
โ  - Factura fiscal creada con items seleccionados                 โ
โ  - Auto-imputaciรณn creada (si hubo pago)                         โ
โ  - Recibo de excedente creado (si hubo excedente)                โ
โ  - Usuario ve factura en la lista                                โ
โ  - Tab de conversiรณn se cierra                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Puntos Crรญticos del Flujo

### 1. Sincronizaciรณn de IDs de Items Seleccionados

**Problema**: Mantener los IDs de items seleccionados a travรฉs de mรบltiples funciones asรญncronas.

**Soluciรณn**:
- El modal mantiene `selectedItems` como estado local
- Al confirmar, se pasan como `itemsSeleccionadosIds` (prop) a ConVentaForm
- ConVentaForm crea un estado local `idsSeleccionados` sincronizado con el prop
- **CRรTICO**: Todas las funciones de submit deben usar `idsSeleccionados` (estado), NO `itemsSeleccionadosIds` (prop)

```javascript
// โ CORRECTO
const [idsSeleccionados, setIdsSeleccionados] = useState(itemsSeleccionadosIds);

useEffect(() => {
  if (itemsSeleccionadosIds) {
    setIdsSeleccionados(itemsSeleccionadosIds);
  }
}, [itemsSeleccionadosIds]);

// En handleSubmit y realizarSubmitVenta:
payload.items_seleccionados = idsSeleccionados; // โ Usa ESTADO
```

```javascript
// โ INCORRECTO
payload.items_seleccionados = itemsSeleccionadosIds; // โ Usa PROP (puede estar vacรญo)
```

### 2. Diferencia entre Conversiรณn de Presupuesto vs Factura Interna

| Aspecto | Presupuesto โ Factura | Factura Interna โ Factura |
|---------|----------------------|---------------------------|
| Selecciรณn de items | โ Sรญ, usuario elige | โ No, conversiรณn total |
| Campo en payload | `items_seleccionados` | `items` |
| Campo origen | `presupuesto_origen` | `factura_interna_origen` |
| Tipo conversiรณn | `presupuesto_factura` | `factura_i_factura` |
| Endpoint | `/api/convertir-presupuesto/` | `/api/convertir-factura-interna/` |
| Stock | Descuenta stock | NO descuenta (ya descontado) |

### 3. Manejo de Recibo de Excedente

**Condiciones**:
- `montoPago > total + 0.99` (tolerancia de 99 centavos)
- Usuario acepta crear recibo

**Flujo**:
1. Detectar excedente en `handleSubmit`
2. Abrir `NuevoReciboModal` con datos precargados
3. Usuario completa/modifica datos del recibo
4. Al guardar modal โ `handleReciboExcedenteGuardado(reciboData)`
5. Guardar `reciboData` en estado
6. Llamar `realizarSubmitVenta(reciboData)` con timeout de 100ms
7. `realizarSubmitVenta` incluye `recibo_excedente` en payload
8. Backend crea recibo separado

**Datos del recibo**:
```javascript
{
  rec_fecha: '2025-10-11',
  rec_pv: '0002',          // Punto de venta
  rec_numero: '00112233',  // Nรบmero de recibo
  rec_monto_total: 19651.76, // Excedente
  rec_observacion: '',
  rec_tipo: 'recibo'
}
```

### 4. Acceso a Campos Calculados en Backend

**Problema**: El modelo `Venta` NO tiene campos calculados como `ven_total`.

**Soluciรณn**: Usar `VentaCalculada` (vista SQL):

```python
# โ INCORRECTO
total = venta.ven_total  # AttributeError

# โ CORRECTO
from ferreapps.ventas.models import VentaCalculada

venta_calculada = VentaCalculada.objects.filter(ven_id=venta.ven_id).first()
total = Decimal(str(venta_calculada.ven_total)) if venta_calculada else Decimal('0')
```

---

## ๐ฆ Estructura de Payloads

### Payload de Conversiรณn de Presupuesto (SIN recibo)

```json
{
  "ven_estado": "CE",
  "ven_tipo": "Venta",
  "tipo_comprobante": "factura",
  "ven_numero": 1,
  "ven_sucursal": 1,
  "ven_fecha": "2025-10-11",
  "ven_impneto": 0,
  "ven_descu1": 0,
  "ven_descu2": 0,
  "ven_descu3": 0,
  "ven_bonificacion_general": 0,
  "ven_total": 0,
  "ven_idcli": 3,
  "ven_idpla": 2,
  "ven_idvdo": 1,
  "ven_copia": 1,
  "comprobante_pagado": false,
  "monto_pago": 0,
  "items_seleccionados": [123, 124, 125],  โ CRรTICO
  "presupuesto_origen": 110,
  "tipo_conversion": "presupuesto_factura",
  "ven_cuit": "20002307554",
  "ven_domicilio": "MIGUELETES 401 Piso:2 Dpto:8"
}
```

### Payload de Conversiรณn de Presupuesto (CON recibo de excedente)

```json
{
  "ven_estado": "CE",
  "ven_tipo": "Venta",
  "tipo_comprobante": "factura",
  "ven_numero": 1,
  "ven_sucursal": 1,
  "ven_fecha": "2025-10-11",
  "ven_idcli": 3,
  "ven_idpla": 2,
  "ven_idvdo": 1,
  "ven_copia": 1,
  "comprobante_pagado": true,        โ Indica pago
  "monto_pago": 100000,              โ Monto total del pago
  "items_seleccionados": [123, 124, 125],
  "presupuesto_origen": 110,
  "tipo_conversion": "presupuesto_factura",
  "recibo_excedente": {              โ Datos del recibo
    "rec_fecha": "2025-10-11",
    "rec_pv": "0002",
    "rec_numero": "00112233",
    "rec_monto_total": 19651.76,     โ Solo el excedente
    "rec_observacion": "",
    "rec_tipo": "recibo"
  },
  "ven_cuit": "20002307554",
  "ven_domicilio": "MIGUELETES 401 Piso:2 Dpto:8"
}
```

### Payload de Conversiรณn de Factura Interna

```json
{
  "ven_estado": "CE",
  "ven_tipo": "Venta",
  "tipo_comprobante": "factura",
  "ven_numero": 1,
  "ven_sucursal": 1,
  "ven_fecha": "2025-10-11",
  "ven_idcli": 3,
  "ven_idpla": 2,
  "ven_idvdo": 1,
  "ven_copia": 1,
  "comprobante_pagado": false,
  "monto_pago": 0,
  "items": [...],                    โ Items completos (no IDs)
  "factura_interna_origen": 95,      โ ID de factura interna
  "tipo_conversion": "factura_i_factura",
  "ven_cuit": "20002307554",
  "ven_domicilio": "MIGUELETES 401 Piso:2 Dpto:8"
}
```

---

## ๐ Problemas Comunes y Soluciones

### Problema 1: `items_seleccionados` llega vacรญo al backend

**Sรญntoma**: Error "Faltan datos de presupuesto o รญtems seleccionados"

**Causas**:
1. Se usa `itemsSeleccionadosIds` (prop) en lugar de `idsSeleccionados` (estado)
2. El prop no se sincronizรณ correctamente
3. El estado no se inicializรณ

**Soluciรณn**:
```javascript
// Verificar que realizarSubmitVenta use el estado:
payload.items_seleccionados = idsSeleccionados; // โ

// NO usar el prop:
payload.items_seleccionados = itemsSeleccionadosIds; // โ
```

### Problema 2: Error "Venta object has no attribute ven_total"

**Sรญntoma**: AttributeError en backend

**Causa**: Intentar acceder a campo calculado desde modelo Venta

**Soluciรณn**:
```python
# โ No hacer esto:
total = venta.ven_total

# โ Hacer esto:
venta_calculada = VentaCalculada.objects.filter(ven_id=venta.ven_id).first()
total = Decimal(str(venta_calculada.ven_total)) if venta_calculada else Decimal('0')
```

### Problema 3: Recibo de excedente no se crea

**Causas**:
1. `realizarSubmitVenta` no recibe `reciboData` como parรกmetro
2. No se incluye `recibo_excedente` en payload
3. Backend no procesa el campo `recibo_excedente`

**Soluciรณn**: Verificar que:
- `handleReciboExcedenteGuardado` llame `realizarSubmitVenta(reciboData)`
- `realizarSubmitVenta` agregue `payload.recibo_excedente = reciboData`
- Backend tenga lรณgica para procesar `data.get('recibo_excedente')`

### Problema 4: Auto-imputaciรณn no se crea

**Causas**:
1. `comprobante_pagado` es false
2. `monto_pago` es 0
3. Backend no tiene lรณgica de auto-imputaciรณn en el endpoint de conversiรณn

**Soluciรณn**: Verificar que el backend tenga:
```python
comprobante_pagado = venta_data.get('comprobante_pagado', False)
monto_pago = Decimal(str(venta_data.get('monto_pago', 0)))

if comprobante_pagado and monto_pago > 0:
    venta_calculada = VentaCalculada.objects.filter(ven_id=venta_creada.ven_id).first()
    total_venta = Decimal(str(venta_calculada.ven_total)) if venta_calculada else Decimal('0')
    monto_auto_imputacion = min(monto_pago, total_venta)
    
    ImputacionVenta.objects.create(
        imp_id_venta=venta_creada,
        imp_id_recibo=venta_creada,
        imp_monto=monto_auto_imputacion,
        imp_fecha=date.today(),
        imp_observacion='Factura Recibo - Auto-imputaciรณn'
    )
```

---

## ๐ Referencias

- **Modelo Venta vs VentaCalculada**: Ver `Documentacion/MODELO_VENTA_CAMPOS.md`
- **Componente ConVentaForm**: `ferredesk_v0/frontend/src/components/Presupuestos y Ventas/ConVentaForm.js`
- **Hook useComprobantesCRUD**: `ferredesk_v0/frontend/src/components/Presupuestos y Ventas/hooks/useComprobantesCRUD.js`
- **Backend convertir_presupuesto**: `ferredesk_v0/backend/ferreapps/ventas/views.py` lรญnea 762
- **Backend convertir_factura_interna**: `ferredesk_v0/backend/ferreapps/ventas/views.py` lรญnea 1198

---

*รltima actualizaciรณn: 2025-10-11*

